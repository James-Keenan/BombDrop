<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>BombDrop</title>
    <style>
        /* Reset CSS: Please avoid making changes here unless you know what you're doing :) */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent scrolling on mobile */
        }

        body {
            line-height: 1;
            font-family: Arial, sans-serif;
            background-color: #040218;
        }
        
        /* Game container takes full screen */
        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #040218;
        }
        
        /* Canvas fills the container */
        #game-container canvas {
            width: 100% !important;
            height: 100% !important;
            max-width: none !important;
            max-height: none !important;
            display: block !important;
            background-color: #040218 !important;
        }
        
        /* Mobile-specific adjustments */
        @media (max-width: 768px), (max-height: 768px) {
            html, body {
                width: 100%;
                height: 100vh;
                height: 100dvh; /* Use dynamic viewport height for mobile */
                margin: 0;
                padding: 0;
                overflow: hidden;
                position: fixed;
                background-color: #040218;
                touch-action: manipulation;
                -webkit-overflow-scrolling: touch;
                -webkit-user-select: none;
                user-select: none;
                display: flex;
                flex-direction: column;
            }
            
            #game-container {
                width: 100vw;
                flex: 1;
                min-height: 0;
                position: relative;
                background-color: #040218;
                display: flex;
                align-items: stretch;
                justify-content: stretch;
            }
            
            /* Mobile game canvas - fills entire game area */
            #game-container canvas {
                width: 100% !important;
                height: 100% !important;
                max-width: none !important;
                max-height: none !important;
                display: block !important;
                background-color: #040218 !important;
            }
            
            /* Hide address bar on mobile browsers */
            @supports (-webkit-touch-callout: none) {
                html, body {
                    height: -webkit-fill-available;
                }
            }
        }
        
        /* Mobile Controller UI - only appears on mobile */
        .mobile-controller {
            display: none;
        }
        
        @media (max-width: 768px), (max-height: 768px) {
            .mobile-controller {
                display: none; /* Hidden by default */
                width: 100vw;
                height: 160px;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
                border-top: 3px solid #4a5568;
                padding: 10px 15px;
                box-sizing: border-box;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                position: relative;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
                flex-shrink: 0;
            }
            
            /* Force hide controller during upgrades */
            .mobile-controller.upgrade-mode {
                display: none !important;
            }
            
            /* Show controller only during gameplay */
            .mobile-controller.game-active {
                display: flex;
            }
            
            /* Centered row for main movement buttons */
            .controller-center-row {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 40px;
                width: 100%;
            }
            
            /* Bottom row layout with centered down button */
            .controller-bottom-row {
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
                padding: 0 20px;
                position: relative;
            }
            
            /* Left side abilities - positioned absolutely to left */
            .left-abilities {
                display: flex;
                gap: 12px;
                align-items: center;
                position: absolute;
                left: 20px;
            }
            
            /* Right side abilities - positioned absolutely to right */
            .right-abilities {
                display: flex;
                gap: 12px;
                align-items: center;
                position: absolute;
                right: 20px;
            }
            
            /* Premium ability buttons - larger circular */
            .ability-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
                border-radius: 50%;
                border: 2px solid rgba(255, 255, 255, 0.5);
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
                font-weight: bold;
                color: #ffffff;
            }
            
            .barrier-btn {
                background: linear-gradient(135deg, rgba(155, 89, 182, 0.8), rgba(142, 68, 173, 0.8));
                border-radius: 50%;
            }
            
            .emp-btn {
                background: linear-gradient(135deg, rgba(243, 156, 18, 0.8), rgba(230, 126, 34, 0.8));
                border-radius: 50%;
            }
            
            .sonic-btn {
                background: linear-gradient(135deg, rgba(135, 206, 235, 0.8), rgba(107, 182, 224, 0.8));
                border-radius: 50%;
            }
            
            /* Jump button - larger size */
            .jump-btn {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #50c878, #3da55c);
                font-size: 26px;
                border-radius: 50%;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }
            
            /* Move buttons - larger size */
            .move-btn {
                width: 60px;
                height: 50px;
                background: linear-gradient(135deg, #4a90e2, #357abd);
                font-size: 22px;
                border-radius: 6px;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }
            
            /* Fast fall button - centered like jump button */
            #fast-fall {
                position: relative;
                z-index: 2;
            }
            
            /* Mobile game text scaling */
            .phaser-game-object {
                transform: scale(1.2);
            }
            
            /* Target upgrade text specifically */
            canvas {
                font-size: 24px !important;
            }
        }
        
        /* Mobile-specific text scaling for Phaser game content */
        @media (max-width: 768px), (max-height: 768px) {
            body.mobile-device {
                /* Increase overall text rendering scale */
                text-size-adjust: 150%;
                -webkit-text-size-adjust: 150%;
                -moz-text-size_adjust: 150%;
                -ms-text-size_adjust: 150%;
            }
            
            /* Scale game canvas text elements */
            #game-container {
                font-size: 18px;
                line-height: 1.4;
            }
            
            /* Ensure touch targets are larger */
            * {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* Debug styles - remove in production */
        #debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-size: 14px;
            z-index: 1000;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <!-- Mobile Controller - only visible on mobile devices -->
    <div class="mobile-controller">
        <!-- Top Row - Main Movement Buttons -->
        <div class="controller-center-row">
            <button class="control-btn move-btn" id="move-left">‚Üê</button>
            <button class="control-btn jump-btn" id="jump">‚Üë</button>
            <button class="control-btn move-btn" id="move-right">‚Üí</button>
        </div>
        
        <!-- Bottom Row - Fast Fall centered with Power-ups on sides -->
        <div class="controller-bottom-row">
            <div class="left-abilities">
                <button class="control-btn ability-btn barrier-btn" id="barrier" disabled>
                    üõ°Ô∏è
                </button>
                <button class="control-btn ability-btn emp-btn" id="emp" disabled>
                    ‚ö°
                </button>
            </div>
            
            <button class="control-btn move-btn fast-fall-btn" id="fast-fall" disabled>
                ‚Üì
            </button>
            
            <div class="right-abilities">
                <button class="control-btn ability-btn sonic-btn" id="sonic" disabled>
                    üîä
                </button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced mobile detection
        function detectMobile() {
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const isSmallScreen = window.innerWidth <= 768 || window.innerHeight <= 768;
            const hasOrientation = typeof window.orientation !== "undefined";
            
            return isMobileUA || hasOrientation || (hasTouch && isSmallScreen);
        }
        
        // Global functions for game scene communication
        window.showMobileController = function() {
            if (detectMobile()) {
                const controller = document.querySelector('.mobile-controller');
                if (controller && !controller.classList.contains('upgrade-mode')) {
                    controller.classList.add('game-active');
                    console.log('Mobile controller shown');
                    setupMobileControllers();
                } else {
                    console.log('Mobile controller NOT shown - in upgrade mode');
                }
            }
        };
        
        window.hideMobileController = function() {
            const controller = document.querySelector('.mobile-controller');
            if (controller) {
                controller.classList.remove('game-active');
                controller.classList.remove('upgrade-mode');
                console.log('Mobile controller hidden');
            }
        };
        
        // Hide controller during upgrade screens
        window.hideMobileControllerForUpgrades = function() {
            const controller = document.querySelector('.mobile-controller');
            if (controller) {
                controller.classList.remove('game-active');
                controller.classList.add('upgrade-mode');
                console.log('Mobile controller hidden for upgrades');
            }
        };
        
        // Show controller after upgrades
        window.showMobileControllerAfterUpgrades = function() {
            const controller = document.querySelector('.mobile-controller');
            if (controller && detectMobile()) {
                controller.classList.remove('upgrade-mode');
                controller.classList.add('game-active');
                console.log('Mobile controller shown after upgrades');
                setupMobileControllers();
            }
        };
        
        // Check if currently in upgrade mode
        window.isInUpgradeMode = function() {
            const controller = document.querySelector('.mobile-controller');
            return controller && controller.classList.contains('upgrade-mode');
        };
        
        // Enhanced show function that handles upgrades automatically
        window.showMobileControllerForGame = function() {
            const controller = document.querySelector('.mobile-controller');
            if (controller && detectMobile()) {
                // Remove upgrade mode and show for game
                controller.classList.remove('upgrade-mode');
                controller.classList.add('game-active');
                console.log('Mobile controller shown for game');
                setupMobileControllers();
            }
        };
        
        // Auto-detect scene changes and show/hide controller appropriately
        window.checkSceneAndUpdateController = function(sceneName) {
            console.log('Scene changed to:', sceneName);
            
            if (detectMobile()) {
                const controller = document.querySelector('.mobile-controller');
                if (!controller) return;
                
                if (sceneName === 'Game' || sceneName === 'GameScene') {
                    // Show controller for game scenes
                    controller.classList.remove('upgrade-mode');
                    controller.classList.add('game-active');
                    setupMobileControllers();
                    console.log('Controller shown for game scene');
                } else if (sceneName === 'CharacterSelect' || sceneName === 'Upgrade' || sceneName === 'UpgradeScene') {
                    // Hide controller for upgrade scenes
                    controller.classList.remove('game-active');
                    controller.classList.add('upgrade-mode');
                    console.log('Controller hidden for upgrade scene');
                } else {
                    // Hide controller for other scenes (menu, etc.)
                    controller.classList.remove('game-active');
                    controller.classList.remove('upgrade-mode');
                    console.log('Controller hidden for other scene');
                }
            }
        };
        
        // Force hide controller immediately when page loads
        window.addEventListener('DOMContentLoaded', function() {
            const controller = document.querySelector('.mobile-controller');
            if (controller) {
                // DON'T force upgrade-mode initially - let the game load normally
                console.log('Controller ready - waiting for game to load');
            }
        });
        
        function setupMobileLayout() {
            if (detectMobile()) {
                console.log('Mobile device detected - setting up mobile layout');
                document.body.classList.add('mobile-device');
                
                // DON'T setup mobile controllers immediately - wait for game
                
                // Prevent zoom on double tap
                document.addEventListener('touchstart', function(event) {
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });
                
                // Prevent context menu and text selection
                document.addEventListener('contextmenu', function(event) {
                    event.preventDefault();
                });
                
                document.addEventListener('selectstart', function(event) {
                    event.preventDefault();
                });
            } else {
                console.log('Desktop device detected');
                document.body.classList.remove('mobile-device');
            }
        }
        
        // Set up mobile layout immediately
        setupMobileLayout();
        
        // Handle orientation and resize changes
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                setupMobileLayout();
                // Force viewport refresh
                window.scrollTo(0, 1);
                setTimeout(() => window.scrollTo(0, 0), 1);
            }, 100);
        });
        
        window.addEventListener('resize', function() {
            setTimeout(setupMobileLayout, 100);
        });
        
        // Force mobile layout setup after page load
        window.addEventListener('load', function() {
            setupMobileLayout();
            // Hide address bar on iOS
            setTimeout(() => {
                window.scrollTo(0, 1);
                setTimeout(() => window.scrollTo(0, 0), 1);
            }, 500);
        });
        
        document.addEventListener('DOMContentLoaded', setupMobileLayout);
        
        // Mobile Controller Button Event Handlers
        function setupMobileControllers() {
            if (!detectMobile()) return;
            
            console.log('Setting up mobile controllers...');
            
            // Setup each button with direct event handling (no cloning)
            const buttonConfigs = [
                { id: 'move-left', key: 37, name: 'Left', continuous: true },
                { id: 'move-right', key: 39, name: 'Right', continuous: true },
                { id: 'jump', key: 38, name: 'Jump', continuous: false },
                { id: 'fast-fall', key: 40, name: 'Fast Fall', continuous: true },
                { id: 'barrier', key: 87, name: 'Barrier', continuous: false }, // W key
                { id: 'emp', key: 69, name: 'EMP', continuous: false }, // E key  
                { id: 'sonic', key: 81, name: 'Sonic', continuous: false } // Q key
            ];
            
            buttonConfigs.forEach(({ id, key, name, continuous }) => {
                const button = document.getElementById(id);
                if (!button) {
                    console.log(`Button ${id} not found`);
                    return;
                }
                
                // Remove existing listeners without cloning
                button.onclick = null;
                button.ontouchstart = null;
                button.ontouchend = null;
                
                let isPressed = false;
                
                const handleStart = (e) => {
                    e.preventDefault();
                    
                    // Simple check - if data-unlocked is true, always allow
                    const isUnlocked = button.getAttribute('data-unlocked') === 'true';
                    
                    // Only check disabled state if NOT unlocked
                    let isBlocked = false;
                    if (!isUnlocked) {
                        isBlocked = button.hasAttribute('disabled') || button.disabled === true;
                    }
                    
                    console.log(`${name} button pressed:`, {
                        isUnlocked: isUnlocked,
                        isBlocked: isBlocked,
                        disabled: button.disabled,
                        hasDisabledAttr: button.hasAttribute('disabled')
                    });
                    
                    if (isBlocked || isPressed) {
                        console.log(`${name} blocked - isBlocked: ${isBlocked}, isPressed: ${isPressed}`);
                        return;
                    }
                    
                    console.log(`${name} ACTIVATED!`);
                    
                    isPressed = true;
                    button.style.transform = 'scale(0.9)';
                    button.style.filter = 'brightness(1.2)';
                    
                    // Enhanced keyboard event dispatch with more properties
                    const event = new KeyboardEvent('keydown', {
                        keyCode: key,
                        which: key,
                        key: key === 69 ? 'e' : key === 81 ? 'q' : key === 87 ? 'w' : String.fromCharCode(key).toLowerCase(),
                        code: key === 69 ? 'KeyE' : key === 81 ? 'KeyQ' : key === 87 ? 'KeyW' : `Key${String.fromCharCode(key)}`,
                        bubbles: true,
                        cancelable: true,
                        composed: true
                    });
                    
                    // Dispatch to both document and window for maximum compatibility
                    document.dispatchEvent(event);
                    window.dispatchEvent(event);
                    console.log(`${name} keydown dispatched - keyCode: ${key}, key: ${event.key}, code: ${event.code}`);
                    
                    // For abilities, send keyup immediately
                    if (!continuous) {
                        setTimeout(() => {
                            const upEvent = new KeyboardEvent('keyup', {
                                keyCode: key,
                                which: key,
                                key: event.key,
                                code: event.code,
                                bubbles: true,
                                cancelable: true,
                                composed: true
                            });
                            document.dispatchEvent(upEvent);
                            window.dispatchEvent(upEvent);
                            console.log(`${name} keyup dispatched`);
                        }, 100);
                    }
                };
                
                const handleEnd = (e) => {
                    if (e) e.preventDefault();
                    
                    if (!isPressed) return;
                    
                    isPressed = false;
                    button.style.transform = 'scale(1)';
                    button.style.filter = 'brightness(1)';
                    
                    // Send keyup for continuous actions
                    if (continuous) {
                        const upEvent = new KeyboardEvent('keyup', {
                            keyCode: key,
                            which: key,
                            bubbles: true,
                            cancelable: true
                        });
                        document.dispatchEvent(upEvent);
                        console.log(`${name} keyup dispatched`);
                    }
                };
                
                // Add event listeners directly
                button.addEventListener('touchstart', handleStart, { passive: false });
                button.addEventListener('touchend', handleEnd, { passive: false });
                button.addEventListener('mousedown', handleStart);
                button.addEventListener('mouseup', handleEnd);
                
                console.log(`${name} button setup complete`);
            });
            
            console.log('Mobile controllers setup complete');
        }
        
        // Enhanced unlock function that forces button state
        window.unlockMobilePowerUp = function(powerUpName) {
            console.log('UNLOCK CALLED:', powerUpName);
            
            if (!detectMobile()) {
                console.log('Not mobile, skipping unlock');
                return;
            }
            
            const buttonMap = {
                'fast fall': 'fast-fall',
                'fastfall': 'fast-fall',
                'double jump': 'fast-fall',
                'down fall': 'fast-fall',
                'emp': 'emp',
                'emp blast': 'emp',
                'barrier': 'barrier',
                'shield': 'barrier',
                'shield barrier': 'barrier',
                'sonic': 'sonic',
                'sonic boom': 'sonic'
            };
            
            const buttonId = buttonMap[powerUpName.toLowerCase()];
            const button = document.getElementById(buttonId);
            
            if (button) {
                console.log('UNLOCKING BUTTON:', buttonId);
                
                // Force enable and style the button
                button.disabled = false;
                button.removeAttribute('disabled');
                button.setAttribute('data-unlocked', 'true');
                button.style.opacity = '1';
                button.style.pointerEvents = 'auto';
                button.style.cursor = 'pointer';
                
                // Apply specific styling based on button type
                if (buttonId === 'fast-fall') {
                    button.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
                    button.style.border = '2px solid rgba(255, 255, 255, 0.5)';
                    button.style.boxShadow = '0 0 8px rgba(74, 144, 226, 0.4)';
                    button.classList.remove('fast-fall-btn');
                    button.classList.add('move-btn');
                } else if (buttonId === 'emp') {
                    button.style.background = 'linear-gradient(135deg, rgba(243, 156, 18, 0.8), rgba(230, 126, 34, 0.8))';
                    button.style.border = '2px solid rgba(255, 255, 255, 0.5)';
                    button.style.textShadow = '0 1px 3px rgba(0, 0, 0, 0.8)';
                    button.style.color = '#ffffff';
                    button.style.fontWeight = 'bold';
                } else if (buttonId === 'barrier') {
                    button.style.background = 'linear-gradient(135deg, rgba(155, 89, 182, 0.8), rgba(142, 68, 173, 0.8))';
                    button.style.border = '2px solid rgba(255, 255, 255, 0.5)';
                    button.style.textShadow = '0 1px 3px rgba(0, 0, 0, 0.8)';
                    button.style.color = '#ffffff';
                    button.style.fontWeight = 'bold';
                } else if (buttonId === 'sonic') {
                    button.style.background = 'linear-gradient(135deg, rgba(135, 206, 235, 0.8), rgba(107, 182, 224, 0.8))';
                    button.style.border = '2px solid rgba(255, 255, 255, 0.5)';
                    button.style.textShadow = '0 1px 3px rgba(0, 0, 0, 0.8)';
                    button.style.color = '#ffffff';
                    button.style.fontWeight = 'bold';
                }
                
                console.log(`${powerUpName} mobile button unlocked and styled!`);
            } else {
                console.log('Button NOT found:', buttonId);
            }
        };
        
        // Global function for the game to call when upgrades are unlocked
        window.onUpgradePurchased = function(upgradeName) {
            console.log('Upgrade purchased:', upgradeName);
            
            // Check if it's a mobile-relevant upgrade
            const mobileMappings = {
                'double jump': 'fast fall',
                'fast fall': 'fast fall',
                'down fall': 'fast fall',
                'emp blast': 'emp',
                'shield barrier': 'barrier',
                'sonic boom': 'sonic'
            };
            
            const mobileUpgrade = mobileMappings[upgradeName.toLowerCase()];
            if (mobileUpgrade && window.unlockMobilePowerUp) {
                console.log(`Unlocking mobile ${mobileUpgrade} for upgrade: ${upgradeName}`);
                window.unlockMobilePowerUp(mobileUpgrade);
            }
        };
        
        // Simple test function that works immediately
        window.testFastFall = function() {
            console.log('Testing Fast Fall unlock...');
            window.unlockMobilePowerUp('fast fall');
            
            // Verify it worked
            const button = document.getElementById('fast-fall');
            if (button) {
                console.log('Fast Fall button state:', {
                    disabled: button.disabled,
                    dataUnlocked: button.getAttribute('data-unlocked'),
                    background: button.style.background
                });
            }
        };
        
        // Test function to manually unlock fast fall for testing
        window.testUnlockFastFall = function() {
            console.log('TEST: Unlocking fast fall');
            const button = document.getElementById('fast-fall');
            if (button) {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
                console.log('Fast fall button enabled for testing');
            }
        };
        
        // Test function that unlocks and re-setups controllers
        window.testUnlockAll = function() {
            console.log('Testing unlock all abilities');
            window.unlockMobilePowerUp('fast fall');
            
            // Re-setup controllers after unlock to ensure proper event handling
            setTimeout(() => {
                setupMobileControllers();
                console.log('Controllers re-setup after unlock');
                
                // Check final button state
                const fastFallBtn = document.getElementById('fast-fall');
                if (fastFallBtn) {
                    console.log('Fast fall button final state:');
                    console.log('- disabled:', fastFallBtn.disabled);
                    console.log('- hasAttribute:', fastFallBtn.hasAttribute('disabled'));
                    console.log('- data-unlocked:', fastFallBtn.getAttribute('data-unlocked'));
                }
            }, 200);
            
            window.unlockMobilePowerUp('emp');
            window.unlockMobilePowerUp('barrier');
            window.unlockMobilePowerUp('sonic');
        };
        
        // Test function that forces Fast Fall unlock
        window.forceUnlockFastFall = function() {
            console.log('FORCE UNLOCKING Fast Fall...');
            
            const button = document.getElementById('fast-fall');
            if (button) {
                // Force enable completely
                button.disabled = false;
                button.removeAttribute('disabled');
                button.setAttribute('data-unlocked', 'true');
                button.style.opacity = '1';
                button.style.pointerEvents = 'auto';
                button.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
                button.style.border = '2px solid rgba(255, 255, 255, 0.5)';
                button.style.boxShadow = '0 0 8px rgba(74, 144, 226, 0.4)';
                button.classList.remove('fast-fall-btn');
                button.classList.add('move-btn');
                
                console.log('Fast Fall button force unlocked:', {
                    disabled: button.disabled,
                    dataUnlocked: button.getAttribute('data-unlocked'),
                    classList: button.className
                });
            }
        };
        
        // Add mobile text scaling for Phaser
        window.getMobileTextScale = function() {
            if (detectMobile()) {
                return 1.5; // 50% larger text on mobile
            }
            return 1;
        };
        
        // Add mobile UI scaling
        window.getMobileUIScale = function() {
            if (detectMobile()) {
                return 1.3; // 30% larger UI elements on mobile
            }
            return 1;
        };
        
        // Function to apply mobile text styling to Phaser scenes
        window.applyMobileTextStyling = function(textObject) {
            if (detectMobile() && textObject) {
                const scale = window.getMobileTextScale();
                if (textObject.setScale) {
                    textObject.setScale(scale);
                }
                if (textObject.setFontSize) {
                    const currentSize = textObject.style?.fontSize || 16;
                    textObject.setFontSize(Math.floor(currentSize * scale));
                }
                if (textObject.setLineSpacing) {
                    textObject.setLineSpacing(6);
                }
            }
            return textObject;
        };
        
        // Test functions for all abilities
        window.testUnlockSonic = function() {
            console.log('Testing Sonic unlock...');
            window.unlockMobilePowerUp('sonic');
        };
        
        window.testUnlockBarrier = function() {
            console.log('Testing Barrier unlock...');
            window.unlockMobilePowerUp('barrier');
        };
        
        window.testUnlockEMP = function() {
            console.log('Testing EMP unlock...');
            window.unlockMobilePowerUp('emp');
        };
        
        // Test all abilities at once
        window.testUnlockAllAbilities = function() {
            console.log('Unlocking all mobile abilities...');
            window.unlockMobilePowerUp('fast fall');
            window.unlockMobilePowerUp('barrier');
            window.unlockMobilePowerUp('emp');
            window.unlockMobilePowerUp('sonic');
        };
        
        // Test EMP specifically
        window.testEMP = function() {
            console.log('Testing EMP key dispatch...');
            
            // Test E key directly
            const eKeyDown = new KeyboardEvent('keydown', {
                keyCode: 69,
                which: 69,
                key: 'e',
                code: 'KeyE',
                bubbles: true,
                cancelable: true
            });
            
            const eKeyUp = new KeyboardEvent('keyup', {
                keyCode: 69,
                which: 69,
                key: 'e',
                code: 'KeyE',
                bubbles: true,
                cancelable: true
            });
            
            document.dispatchEvent(eKeyDown);
            console.log('E key down dispatched');
            
            setTimeout(() => {
                document.dispatchEvent(eKeyUp);
                console.log('E key up dispatched');
            }, 100);
        };
        
        // Test EMP with direct game interaction
        window.testEMPDirect = function() {
            console.log('Testing EMP directly...');
            
            // First unlock EMP
            window.unlockMobilePowerUp('emp');
            
            // Wait a moment then test
            setTimeout(() => {
                // Try to trigger EMP through the game's input system
                const empEvent = new KeyboardEvent('keydown', {
                    keyCode: 69,
                    which: 69,
                    key: 'e',
                    code: 'KeyE',
                    bubbles: true,
                    cancelable: true
                });
                
                // Try multiple dispatch methods
                document.body.dispatchEvent(empEvent);
                document.dispatchEvent(empEvent);
                window.dispatchEvent(empEvent);
                
                console.log('EMP event dispatched to multiple targets');
                
                // Check if there's a game scene and try to trigger EMP directly
                const gameScene = window.game?.scene?.getScene('Game');
                if (gameScene && gameScene.cursors && gameScene.cursors.emp) {
                    console.log('Found game scene, triggering EMP directly');
                    gameScene.cursors.emp.isDown = true;
                    setTimeout(() => {
                        gameScene.cursors.emp.isDown = false;
                    }, 100);
                }
            }, 500);
        };
    </script>
    <script src="./phaser.js"></script>
    <script type="module" src="./src/main.js"></script>
</body>
</html>